name: main
on:
  workflow_dispatch:
  pull_request:
  push:
    tags:
      - "*"
#   branches:
#     - master
#   paths-ignore:
#     - ".github/**"
#     - "!.github/workflows/main.yml"
#     - "docs/**"
#     - "*.md"
#     - ".git*"

jobs:

  build-linux:
    runs-on: ubuntu-20.04
    timeout-minutes: 14400
    strategy:
      fail-fast: true
      matrix:
        PYTHON_VERSION: ["3.10"]
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: Setup conda environment
        run: |
          curl -L https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-Linux-x86_64.sh --output /tmp/conda.sh --silent \
          && bash /tmp/conda.sh -b -p /opt/conda \
          && rm -rf /tmp/conda.sh \
          && source /opt/conda/etc/profile.d/conda.sh \
          && mamba install -y python=${{ matrix.PYTHON_VERSION }} numpy scipy suitesparse pybind11 build wheel \
          && pip install jax jaxlib
      - name: build library
        run: |
          source /opt/conda/etc/profile.d/conda.sh \
          && conda activate base \
          && python setup.py build sdist bdist_wheel \
          && ls dist
      - name: Expose wheel as artifact
        uses: actions/upload-artifact@master
        with:
          name: dist-linux
          path: dist

  release:
    runs-on: ubuntu-latest
    needs:
      - build-linux
    strategy:
      fail-fast: true
      matrix:
        PYTHON_VERSION: ["310"]
    steps:
      - name: Download dist artifact
        uses: actions/download-artifact@master
        with:
          name: dist-linux
          path: dist
      - name: Rename Linux wheels
        run: |
          mv dist/klujax-0.1.1-cp${{ matrix.PYTHON_VERSION }}-cp${{ matrix.PYTHON_VERSION }}-linux_x86_64.whl \
             dist/klujax-0.1.1-cp${{ matrix.PYTHON_VERSION }}-cp${{ matrix.PYTHON_VERSION }}-manylinux2014_x86_64.whl
      - name: Show dist contents
        run: ls dist
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          fail_on_unmatched_files: false
          files: dist/klujax-0.1.1-cp${{ matrix.PYTHON_VERSION }}-cp${{ matrix.PYTHON_VERSION }}-manylinux2014_x86_64.whl
